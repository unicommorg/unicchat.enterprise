#!/usr/bin/env bash
#
# UnicChat installation helper with VCS support (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2025-09-10)
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() { echo -e "${BLUE}üìù ${NC}$1"; }
log_success() { echo -e "${GREEN}‚úÖ ${NC}$1"; }
log_warning() { echo -e "${YELLOW}‚ö†Ô∏è ${NC}$1"; }
log_error() { echo -e "${RED}‚ùå ${NC}$1"; }

# Ensure running as root or via sudo
if [[ $EUID -ne 0 ]]; then
  log_error "This script must be run as root or with sudo."
  exit 1
fi

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
CONFIG_FILE="app_config.txt"
DNS_CONFIG="dns_config.txt"
VCS_CONFIG="vcs_config.txt"
LICENSE_FILE="license.txt"
MONGO_CONFIG_FILE="mongo_config.txt"
MINIO_CONFIG_FILE="minio_config.txt"
LOG_FILE="unicchat_install.log"

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
EMAIL=""
APP_DNS=""
EDT_DNS=""
MINIO_DNS=""
VCS_DNS=""
VCS_TURN_DNS=""
VCS_WHIP_DNS=""
UNIC_LICENSE=""

# Initialize logging
exec > >(tee -a "$LOG_FILE") 2>&1

log_info "Starting UnicChat installation with VCS - $(date)"

load_config() {
  log_info "Loading configuration..."
  
  # –ó–∞–≥—Ä—É–∂–∞–µ–º email –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
  if [ -f "$CONFIG_FILE" ]; then
    log_info "Loading email from $CONFIG_FILE..."
    EMAIL=$(grep '^EMAIL=' "$CONFIG_FILE" | cut -d '=' -f2- | tr -d '\r' | tr -d '"' | tr -d "'")
  fi
  
  # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º email –µ—Å–ª–∏ –Ω–µ—Ç –≤ –∫–æ–Ω—Ñ–∏–≥–µ
  if [ -z "$EMAIL" ]; then
    log_info "First-time setup:"
    while [ -z "$EMAIL" ]; do
      read -rp "üìß Enter contact email for Let's Encrypt: " EMAIL
      # Basic email validation
      if [[ ! "$EMAIL" =~ ^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$ ]]; then
        log_warning "Invalid email format. Please try again."
        EMAIL=""
      fi
    done
    echo "EMAIL=\"$EMAIL\"" > "$CONFIG_FILE"
    log_success "Email saved to $CONFIG_FILE"
  fi
  
  # –ó–∞–≥—Ä—É–∂–∞–µ–º DNS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
  if [ -f "$DNS_CONFIG" ]; then
    log_info "Loading DNS configuration from $DNS_CONFIG..."
    source "$DNS_CONFIG"
    log_success "DNS names loaded from config"
  fi
  
  # –ó–∞–≥—Ä—É–∂–∞–µ–º VCS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
  if [ -f "$VCS_CONFIG" ]; then
    log_info "Loading VCS configuration from $VCS_CONFIG..."
    source "$VCS_CONFIG"
    log_success "VCS DNS names loaded from config"
  fi
  
  # –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
  if [ -f "$LICENSE_FILE" ]; then
    log_info "Loading license from $LICENSE_FILE..."
    UNIC_LICENSE=$(cat "$LICENSE_FILE" | tr -d '\r' | tr -d '"' | tr -d "'" | xargs)
    if [ -n "$UNIC_LICENSE" ]; then
      log_success "License loaded from $LICENSE_FILE"
    else
      log_warning "License file exists but is empty"
    fi
  fi
}

install_docker() {
  echo -e "\nüê≥ Installing Docker and related components‚Ä¶"

  # –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –ø–∞–∫–µ—Ç—ã –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
  apt remove -y containerd || true
  apt autoremove -y

  apt update -y
  apt install -y ca-certificates curl gnupg lsb-release software-properties-common

  mkdir -p /etc/apt/keyrings
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
    gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  chmod a+r /etc/apt/keyrings/docker.gpg

  echo \
    "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
    https://download.docker.com/linux/ubuntu \
    $(. /etc/os-release; echo "$VERSION_CODENAME") stable" | \
    tee /etc/apt/sources.list.d/docker.list > /dev/null

  apt update -y
  
  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker –ø–∞–∫–µ—Ç—ã —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
  apt install -y -f docker-ce docker-ce-cli containerd.io docker-compose-plugin docker-compose

  echo "‚úÖ Docker and related components installed:"
  echo "   - docker-ce, docker-ce-cli, containerd.io"
  echo "   - docker-compose-plugin, docker-compose"
  echo "   - ca-certificates, curl, gnupg, lsb-release, software-properties-common"
}

install_nginx_ssl() {
  echo -e "\nüåê Installing Nginx and SSL components‚Ä¶"

  apt update -y
  apt install -y nginx certbot python3-certbot-nginx

  echo "‚úÖ Nginx and SSL components installed:"
  echo "   - nginx"
  echo "   - certbot, python3-certbot-nginx"
}

install_git() {
  echo -e "\nüì¶ Installing Git‚Ä¶"

  apt update -y
  apt install -y git

  echo "‚úÖ Git installed"
}

install_dns_utils() {
  echo -e "\nüîç Installing DNS utilities‚Ä¶"

  apt update -y
  apt install -y dnsutils

  echo "‚úÖ DNS utilities installed:"
  echo "   - dnsutils (nslookup, dig, etc.)"
}

install_minio_client() {
  echo -e "\nüì¶ Installing MinIO client (mc)‚Ä¶"
  if ! command -v mc &> /dev/null; then
    curl https://dl.min.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc
    chmod +x /usr/local/bin/mc
    echo "‚úÖ MinIO client installed"
  else
    echo "‚úÖ MinIO client already installed"
  fi
}

docker_compose() {
  if command -v docker compose >/dev/null 2>&1; then
    docker compose "$@"
  elif command -v docker-compose >/dev/null 2>&1; then
    docker-compose "$@"
  else
    echo "‚ùå docker compose not found."
    exit 1
  fi
}

clone_repo() {
  echo -e "\nüì• Cloning repository‚Ä¶"
  if [ ! -d unicchat.enterprise ]; then
    git clone https://github.com/unicommorg/unicchat.enterprise.git
  else
    echo "üìÅ Repository already exists."
  fi
  (cd unicchat.enterprise && git fetch --all && git switch skonstantinov-patch-2 )
  echo "‚úÖ Repo ready on branch skonstantinov-patch-2."
}

check_avx() {
  echo -e "\nüß† Checking CPU for AVX‚Ä¶"
  if grep -m1 -q avx /proc/cpuinfo; then
    echo "‚úÖ AVX supported. You can use MongoDB 5.x+"
  else
    echo "‚ö†Ô∏è No AVX. Use MongoDB 4.4"
  fi
}

setup_dns_names() {
  echo -e "\nüåê Setting up DNS names for all services..."
  
  if [ -f "$DNS_CONFIG" ] && [ -f "$VCS_CONFIG" ]; then
    source "$DNS_CONFIG"
    source "$VCS_CONFIG"
    echo "‚úÖ DNS names loaded from config:"
    echo "   App Server: $APP_DNS"
    echo "   Document Server: $EDT_DNS"
    echo "   MinIO: $MINIO_DNS"
    echo "   VCS: $VCS_DNS"
    echo "   VCS TURN: $VCS_TURN_DNS"
    echo "   VCS WHIP: $VCS_WHIP_DNS"
    return
  fi
  
  echo "üîß Configure DNS names for UnicChat services:"
  
  while [ -z "$APP_DNS" ]; do
    read -rp "Enter DNS for App Server (e.g. app.unic.chat): " APP_DNS
  done
  
  while [ -z "$EDT_DNS" ]; do
    read -rp "Enter DNS for Document Server (e.g. docs.unic.chat): " EDT_DNS
  done
  
  while [ -z "$MINIO_DNS" ]; do
    read -rp "Enter DNS for MinIO (e.g. minio.unic.chat): " MINIO_DNS
  done
  
  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–æ–Ω—Ñ–∏–≥ UnicChat
  cat > "$DNS_CONFIG" <<EOF
APP_DNS="$APP_DNS"
EDT_DNS="$EDT_DNS"
MINIO_DNS="$MINIO_DNS"
EOF
  echo "‚úÖ UnicChat DNS configuration saved to $DNS_CONFIG"
  
  # VCS DNS names - –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª
  echo "üìπ Configure VCS (Video Communication Server) DNS names:"
  
  local vcs_dns=""
  local vcs_turn_dns=""
  local vcs_whip_dns=""
  
  while [ -z "$vcs_dns" ]; do
    read -rp "Enter DNS for VCS Main (e.g. vcs.unic.chat): " vcs_dns
  done
  
  while [ -z "$vcs_turn_dns" ]; do
    read -rp "Enter DNS for VCS TURN (e.g. turn.unic.chat): " vcs_turn_dns
  done
  
  while [ -z "$vcs_whip_dns" ]; do
    read -rp "Enter DNS for VCS WHIP (e.g. whip.unic.chat): " vcs_whip_dns
  done
  
  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è VCS
  cat > "$VCS_CONFIG" <<EOF
VCS_DNS="$vcs_dns"
VCS_TURN_DNS="$vcs_turn_dns"
VCS_WHIP_DNS="$vcs_whip_dns"
EOF
  echo "‚úÖ VCS DNS configuration saved to $VCS_CONFIG"
}

setup_license() {
  echo -e "\nüîë Setting up UnicChat license..."
  
  if [ -f "$LICENSE_FILE" ] && [ -n "$(cat "$LICENSE_FILE" 2>/dev/null | xargs)" ]; then
    UNIC_LICENSE=$(cat "$LICENSE_FILE" | tr -d '\r' | tr -d '"' | tr -d "'" | xargs)
    echo "‚úÖ License already exists in $LICENSE_FILE"
    echo "   License: $UNIC_LICENSE"
    return
  fi
  
  echo "üìù Enter UnicChat License Key (or press Enter to skip):"
  read -rp "License Key: " license_input
  
  if [ -n "$license_input" ]; then
    echo "$license_input" > "$LICENSE_FILE"
    UNIC_LICENSE="$license_input"
    chmod 600 "$LICENSE_FILE"
    log_success "License saved to $LICENSE_FILE"
  else
    log_warning "No license provided. Some features may be limited."
  fi
}

update_mongo_config() {
  echo -e "\nüîß Updating MongoDB configuration..."

  # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  local mongo_config_file="$MONGO_CONFIG_FILE"
  local config_file="unicchat.enterprise/multi-server-install/config.txt"

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤, —Å–æ–∑–¥–∞–Ω–∏–µ –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
  if [ ! -f "$mongo_config_file" ]; then
    log_info "–§–∞–π–ª $mongo_config_file –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π."
    touch "$mongo_config_file"
  fi

  if [ ! -f "$config_file" ]; then
    log_info "–§–∞–π–ª $config_file –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π."
    mkdir -p "$(dirname "$config_file")"
    touch "$config_file"
  fi

  # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ñ–∞–π–ª–µ
  update_config() {
    local key=$1
    local value=$2
    local file=$3
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å –∫–ª—é—á–æ–º
    if grep -q "^$key=" "$file"; then
      # –ó–∞–º–µ–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É
      sed -i "s|^$key=.*|$key=\"$value\"|" "$file"
    else
      # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞
      echo "$key=\"$value\"" >> "$file"
    fi
    if [ $? -eq 0 ]; then
      log_success "–£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: $key=\"$value\" –≤ $file"
    else
      log_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ $key –≤ $file"
      exit 1
    fi
  }

  # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ mongo_config.txt
  get_value_from_mongo_config() {
    local key=$1
    local value
    if grep -q "^$key=" "$mongo_config_file"; then
      value=$(grep "^$key=" "$mongo_config_file" | cut -d'=' -f2 | tr -d '"')
      echo "$value"
    else
      echo ""
    fi
  }

  # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∑–Ω–∞—á–µ–Ω–∏—è —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±–æ–∏—Ö —Ñ–∞–π–ª–æ–≤
  prompt_value() {
    local key=$1
    local prompt=$2
    read -p "$prompt: " value
    if [ -z "$value" ]; then
      log_error "–ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è $key –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º."
      exit 1
    fi
    update_config "$key" "$value" "$mongo_config_file"
    update_config "$key" "$value" "$config_file"
  }

  # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
  local keys=(
    "MONGODB_ROOT_PASSWORD"
    "MONGODB_USERNAME"
    "MONGODB_PASSWORD"
    "MONGODB_DATABASE"
  )

  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
  for key in "${keys[@]}"; do
    value=$(get_value_from_mongo_config "$key")
    if [ -n "$value" ]; then
      # –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –≤ mongo_config.txt, –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ config.txt
      update_config "$key" "$value" "$config_file"
    else
      # –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±–∞ —Ñ–∞–π–ª–∞
      prompt_value "$key" "–í–≤–µ–¥–∏—Ç–µ $key"
    fi
  done

  log_success "MongoDB configuration updated in $mongo_config_file and $config_file."
}

update_minio_config() {
  echo -e "\nüîß Updating MinIO configuration..."

  # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  local minio_config_file="$MINIO_CONFIG_FILE"
  local config_file="unicchat.enterprise/knowledgebase/config.txt"

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤, —Å–æ–∑–¥–∞–Ω–∏–µ –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
  if [ ! -f "$minio_config_file" ]; then
    log_info "–§–∞–π–ª $minio_config_file –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π."
    touch "$minio_config_file"
  fi

  if [ ! -f "$config_file" ]; then
    log_info "–§–∞–π–ª $config_file –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π."
    mkdir -p "$(dirname "$config_file")"
    touch "$config_file"
  fi

  # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ñ–∞–π–ª–µ
  update_config() {
    local key=$1
    local value=$2
    local file=$3
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å –∫–ª—é—á–æ–º
    if grep -q "^$key=" "$file"; then
      # –ó–∞–º–µ–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É
      sed -i "s|^$key=.*|$key=\"$value\"|" "$file"
    else
      # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞
      echo "$key=\"$value\"" >> "$file"
    fi
    if [ $? -eq 0 ]; then
      log_success "–£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: $key=\"$value\" –≤ $file"
    else
      log_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ $key –≤ $file"
      exit 1
    fi
  }

  # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ minio_config.txt
  get_value_from_minio_config() {
    local key=$1
    local value
    if grep -q "^$key=" "$minio_config_file"; then
      value=$(grep "^$key=" "$minio_config_file" | cut -d'=' -f2 | tr -d '"')
      echo "$value"
    else
      echo ""
    fi
  }

  # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∑–Ω–∞—á–µ–Ω–∏—è —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±–æ–∏—Ö —Ñ–∞–π–ª–æ–≤
  prompt_value() {
    local key=$1
    local prompt=$2
    read -p "$prompt: " value
    if [ -z "$value" ]; then
      log_error "–ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è $key –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º."
      exit 1
    fi
    update_config "$key" "$value" "$minio_config_file"
    update_config "$key" "$value" "$config_file"
  }

  # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
  local keys=(
    "DB_NAME"
    "DB_USER"
    "MINIO_ROOT_USER"
    "MINIO_ROOT_PASSWORD"
  )

  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
  for key in "${keys[@]}"; do
    value=$(get_value_from_minio_config "$key")
    if [ -n "$value" ]; then
      # –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –≤ minio_config.txt, –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ config.txt
      update_config "$key" "$value" "$config_file"
    else
      # –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±–∞ —Ñ–∞–π–ª–∞
      prompt_value "$key" "–í–≤–µ–¥–∏—Ç–µ $key"
    fi
  done

  log_success "MinIO configuration updated in $minio_config_file and $config_file."
}

copy_ssl_configs() {
  echo -e "\nüìã Copying SSL configuration files..."

  # –ö–æ–ø–∏—Ä—É–µ–º options-ssl-nginx.conf –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
  if [ ! -f /etc/letsencrypt/options-ssl-nginx.conf ]; then
    if [ -f "unicchat.enterprise/nginx/options-ssl-nginx.conf" ]; then
      sudo cp "unicchat.enterprise/nginx/options-ssl-nginx.conf" /etc/letsencrypt/
      echo "‚úÖ options-ssl-nginx.conf copied to /etc/letsencrypt/"
    else
      echo "‚ö†Ô∏è options-ssl-nginx.conf not found in unicchat.enterprise/nginx/"
    fi
  else
    echo "‚úÖ options-ssl-nginx.conf already exists in /etc/letsencrypt/"
  fi

  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º DH –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
  if [ ! -f /etc/letsencrypt/ssl-dhparams.pem ]; then
    echo -e "\n‚è≥ Generating DH parameters..."
    sudo openssl dhparam -out /etc/letsencrypt/ssl-dhparams.pem 2048
    echo "‚úÖ DH parameters generated"
  else
    echo "‚úÖ DH parameters already exist"
  fi
}

generate_nginx_conf() {
  echo -e "\nüõ†Ô∏è Generating Nginx configs for UnicChat services‚Ä¶"
  
  # –ó–∞–≥—Ä—É–∂–∞–µ–º DNS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –¥–ª—è UnicChat
  if [ ! -f "$DNS_CONFIG" ]; then
    echo "‚ùå DNS configuration not found. Run step 5 first."
    return 1
  fi
  source "$DNS_CONFIG"
  
  # –ü–æ–ª—É—á–∞–µ–º IP —Å–µ—Ä–≤–µ—Ä–∞
  SERVER_IP=$(hostname -I | awk '{print $1}')
  
  # –ü–æ—Ä—Ç—ã –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤
  APP_PORT="8080"
  EDT_PORT="8880"
  MINIO_PORT="9000"
  
  # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∫–æ–Ω—Ñ–∏–≥–æ–≤ –µ—Å–ª–∏ –Ω–µ—Ç
  mkdir -p "unicchat.enterprise/nginx/generated"
  
  # –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥–∞
  generate_config() {
    local domain=$1
    local upstream=$2
    local port=$3
    local output_file="unicchat.enterprise/nginx/generated/${domain}.conf"
    
    echo "üîß Generating config for: $domain ‚Üí $upstream:$port"
    
    cat > "$output_file" <<EOF
# Configuration for $domain
# Generated: $(date)
# Server IP: $SERVER_IP

upstream $upstream {
    server $SERVER_IP:$port;
}

server {
    server_name $domain;
    client_max_body_size 200M;

    error_log /var/log/nginx/${domain}.error.log;
    access_log /var/log/nginx/${domain}.access.log;

    location / {
        proxy_pass http://$upstream;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$http_host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Nginx-Proxy true;
        proxy_redirect off;
    }

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/${domain}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${domain}/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

server {
    server_name $domain;
    listen 80;
    return 301 https://\$host\$request_uri;
}
EOF
    
    echo "‚úÖ Created: $output_file"
  }
  
  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è UnicChat —Å–µ—Ä–≤–∏—Å–æ–≤
  generate_config "$APP_DNS" "myapp" "$APP_PORT"
  generate_config "$EDT_DNS" "edtapp" "$EDT_PORT"
  generate_config "$MINIO_DNS" "myminio" "$MINIO_PORT"
  
  echo "üéâ Nginx configs generated in unicchat.enterprise/nginx/generated/"
  echo "‚ÑπÔ∏è VCS uses Caddy for reverse proxy, no Nginx config needed for VCS domains"
}

deploy_nginx_conf() {
  echo -e "\nüì§ Deploying Nginx configs (excluding VCS)‚Ä¶"
  
  if [ ! -f "$DNS_CONFIG" ]; then
    echo "‚ùå DNS configuration not found. Run step 5 first."
    return 1
  fi
  source "$DNS_CONFIG"
  
  # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏
  if [ -d "unicchat.enterprise/nginx/generated" ]; then
    sudo cp unicchat.enterprise/nginx/generated/*.conf /etc/nginx/sites-available/
    echo "‚úÖ Configs copied to /etc/nginx/sites-available/"
  else
    echo "‚ùå Generated configs directory not found"
    return 1
  fi
  
  # –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è UnicChat –¥–æ–º–µ–Ω–æ–≤
  sudo ln -sf "/etc/nginx/sites-available/${APP_DNS}.conf" "/etc/nginx/sites-enabled/" || true
  sudo ln -sf "/etc/nginx/sites-available/${EDT_DNS}.conf" "/etc/nginx/sites-enabled/" || true
  sudo ln -sf "/etc/nginx/sites-available/${MINIO_DNS}.conf" "/etc/nginx/sites-enabled/" || true
  
  # –£–¥–∞–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
  sudo rm -f /etc/nginx/sites-enabled/default || true
  
  echo "‚úÖ Nginx configs deployed"
  echo "‚ÑπÔ∏è VCS uses Caddy, no Nginx configs needed for VCS domains"
}

setup_ssl() {
  echo -e "\nüîê Setting up SSL certificates for UnicChat domains only‚Ä¶"
  
  # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ DNS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è UnicChat
  if [ ! -f "$DNS_CONFIG" ]; then
    echo "‚ùå DNS configuration not found. Run step 5 first."
    return 1
  fi
  source "$DNS_CONFIG"
  
  # –ö–æ–ø–∏—Ä—É–µ–º SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
  copy_ssl_configs
  
  # –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–æ–º–µ–Ω—ã UnicChat
  local domains=()
  [ -n "$APP_DNS" ] && domains+=("$APP_DNS")
  [ -n "$EDT_DNS" ] && domains+=("$EDT_DNS")
  [ -n "$MINIO_DNS" ] && domains+=("$MINIO_DNS")
  
  if [ ${#domains[@]} -eq 0 ]; then
    echo "‚ùå No domains found in DNS config."
    return 1
  fi
  
  echo "üìã Creating SSL certificates for: ${domains[*]}"
  
  echo "üõë Stopping nginx to free port 80/443..."
  sudo systemctl stop nginx
  if [ $? -ne 0 ]; then
    echo "‚ùå Failed to stop nginx"
    return 1
  fi
  
  for domain in "${domains[@]}"; do
    CERT_PATH="/etc/letsencrypt/live/$domain"
    if [ -d "$CERT_PATH" ]; then
      echo "‚ÑπÔ∏è Certificate for $domain found. Attempting to renew if needed..."
      sudo certbot renew --cert-name "$domain" --quiet --deploy-hook "systemctl reload nginx"
      if [ $? -ne 0 ]; then
        echo "‚ùå Certbot renew failed for $domain"
        sudo systemctl start nginx
        return 1
      fi
    else
      echo "üìù No certificate found for $domain. Requesting new certificate..."
      sudo certbot certonly --standalone --non-interactive --agree-tos --email "$EMAIL" -d "$domain"
      if [ $? -ne 0 ]; then
        echo "‚ùå Certbot failed to obtain certificate for $domain"
        sudo systemctl start nginx
        return 1
      fi
    fi
  done
  
  echo "‚ñ∂Ô∏è Starting nginx..."
  sudo systemctl start nginx
  
  if [ $? -ne 0 ]; then
    echo "‚ùå Failed to start nginx"
    echo "üîç Checking nginx configuration..."
    nginx -t
    return 1
  fi
  
  echo "‚úÖ SSL setup complete for UnicChat domains"
  
  # –û—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è VCS –¥–æ–º–µ–Ω–æ–≤
  if [ -f "$VCS_CONFIG" ]; then
    source "$VCS_CONFIG"
    echo "‚ÑπÔ∏è VCS domains ($VCS_DNS, $VCS_TURN_DNS, $VCS_WHIP_DNS) will use Caddy for SSL"
  fi
}

activate_nginx() {
  echo -e "\nüöÄ Activating Nginx sites‚Ä¶"
  nginx -t && systemctl reload nginx
  echo "‚úÖ Nginx activated for all sites"
}

update_solid_env() {
  echo -e "\nüîó Linking Knowledgebase MinIO with UnicChat solid‚Ä¶"
  
  local solid_env="unicchat.enterprise/multi-server-install/solid.env"
  local kb_config="unicchat.enterprise/knowledgebase/config.txt"
  
  if [ ! -f "$solid_env" ]; then
    echo "‚ùå solid.env file not found: $solid_env"
    return 1
  fi
  
  if [ ! -f "$kb_config" ]; then
    echo "‚ùå Knowledgebase config not found: $kb_config"
    echo "‚ö†Ô∏è Please deploy knowledgebase first to get MinIO credentials"
    return 1
  fi
  
  # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ knowledgebase config
  source "$kb_config"
  
  # –ó–∞–≥—Ä—É–∂–∞–µ–º DNS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
  if [ ! -f "$DNS_CONFIG" ]; then
    echo "‚ùå DNS configuration not found. Run step 5 first."
    return 1
  fi
  source "$DNS_CONFIG"
  
  # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é MinIO –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
  sed -i '/# MinIO Configuration/,/MINIO_SECRET_KEY/d' "$solid_env"
  
  # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é MinIO –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
  cat >> "$solid_env" <<EOF

# MinIO Configuration from Knowledgebase
UnInit.1="'Minio': { 'Type': 'NamedServiceAuth', 'IpOrHost': '$MINIO_DNS', 'UserName': '$MINIO_ROOT_USER', 'Password': '$MINIO_ROOT_PASSWORD' }"
EOF
  
  # –î–æ–±–∞–≤–ª—è–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
  if [ -n "$UNIC_LICENSE" ]; then
    echo "UnicLicense=\"$UNIC_LICENSE\"" >> "$solid_env"
    echo "‚úÖ License added to solid.env"
  fi
  
  echo "‚úÖ Knowledgebase MinIO linked to UnicChat solid"
  echo "   MinIO URL: $MINIO_DNS"
  echo "   Username: $MINIO_ROOT_USER"
}

update_appserver_env() {
  echo -e "\nüîó Linking Document Server with UnicChat appserver‚Ä¶"
  
  local appserver_env="unicchat.enterprise/multi-server-install/appserver.env"
  
  if [ ! -f "$appserver_env" ]; then
    echo "‚ùå appserver.env file not found: $appserver_env"
    return 1
  fi
  
  # –ó–∞–≥—Ä—É–∂–∞–µ–º DNS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
  if [ ! -f "$DNS_CONFIG" ]; then
    echo "‚ùå DNS configuration not found. Run step 5 first."
    return 1
  fi
  source "$DNS_CONFIG"
  
  # –û–±–Ω–æ–≤–ª—è–µ–º ROOT_URL –≤ appserver.env
  sed -i "s|ROOT_URL=.*|ROOT_URL=https://$APP_DNS|" "$appserver_env"
  
  # –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º DOCUMENT_SERVER_HOST
  if ! grep -q "DOCUMENT_SERVER_HOST" "$appserver_env"; then
    echo "DOCUMENT_SERVER_HOST=https://$EDT_DNS" >> "$appserver_env"
  else
    sed -i "s|DOCUMENT_SERVER_HOST=.*|DOCUMENT_SERVER_HOST=https://$EDT_DNS|" "$appserver_env"
  fi
  
  echo "‚úÖ Document Server linked to UnicChat appserver"
  echo "   Document Server URL: https://$EDT_DNS"
}

prepare_all_envs() {
  echo -e "\nüì¶ Preparing all environment files‚Ä¶"
  
  # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ env —Ñ–∞–π–ª—ã
  local dir="unicchat.enterprise/multi-server-install"
  (cd "$dir" && chmod +x generate_env_files.sh && ./generate_env_files.sh)
  
  # –û–±–Ω–æ–≤–ª—è–µ–º solid.env –∏ appserver.env
  update_solid_env
  update_appserver_env
  
  echo "‚úÖ All environment files prepared and updated"
}

update_env_files() {
  echo -e "\nüîó Linking Knowledgebase services with UnicChat‚Ä¶"
  update_solid_env
  update_appserver_env
  echo "‚úÖ All services linked successfully"
}

prepare_unicchat() {
  echo -e "\nüì¶ Preparing env files‚Ä¶"
  prepare_all_envs
}

login_yandex() {
  echo -e "\nüîë Logging into Yandex Container Registry‚Ä¶"
  docker login --username oauth \
    --password y0_AgAAAAB3muX6AATuwQAAAAEawLLRAAB9TQHeGyxGPZXkjVDHF1ZNJcV8UQ \
    cr.yandex
  echo "‚úÖ Logged in."
}

start_unicchat() {
  echo -e "\nüöÄ Starting UnicChat services‚Ä¶"
  local dir="unicchat.enterprise/multi-server-install"
  docker network inspect unicchat-backend >/dev/null 2>&1 || docker network create unicchat-backend
  docker network inspect unicchat-frontend >/dev/null 2>&1 || docker network create unicchat-frontend
  (cd "$dir" && docker_compose -f mongodb.yml -f unic.chat.appserver.yml -f unic.chat.solid.yml  up -d)
  echo "‚úÖ Services started."
}

update_site_url() {
  echo -e "\nüìù Updating Site_Url in MongoDB‚Ä¶"
  local container="unic.chat.db.mongo"
  
  if [ ! -f "$DNS_CONFIG" ]; then
    echo "‚ùå DNS configuration not found. Run step 5 first."
    return 1
  fi
  source "$DNS_CONFIG"
  
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ MongoDB
  if [ ! -f "mongo_config.txt" ]; then
    echo "‚ùå MongoDB configuration not found. Run 'Update MongoDB configuration' first."
    return 1
  fi
  
  # –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MongoDB –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
  source "mongo_config.txt"
  
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  if ! docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
    echo "‚ùå MongoDB container is not running: $container"
    return 1
  fi
  
  local url="https://$APP_DNS"
  
  echo "üîÑ Updating Site_Url to: $url"
  echo "üìä Using database: $MONGODB_DATABASE"
  
  # –ü–µ—Ä–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ value
  docker exec "$container" mongosh -u root -p "$MONGODB_ROOT_PASSWORD" --quiet --eval "db.getSiblingDB('$MONGODB_DATABASE').rocketchat_settings.updateOne({_id:'Site_Url'},{\$set:{value:'$url'}})"
  
  # –í—Ç–æ—Ä–∞—è –∫–æ–º–∞–Ω–¥–∞ - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ packageValue
  docker exec "$container" mongosh -u root -p "$MONGODB_ROOT_PASSWORD" --quiet --eval "db.getSiblingDB('$MONGODB_DATABASE').rocketchat_settings.updateOne({_id:'Site_Url'},{\$set:{packageValue:'$url'}})"
  
  echo "‚úÖ Site_Url updated successfully in database: $MONGODB_DATABASE"
}

prepare_knowledgebase() {
  echo -e "\nüìö Preparing knowledge base deployment‚Ä¶"
  local kb_dir="unicchat.enterprise/knowledgebase"
  
  if [ ! -d "$kb_dir" ]; then
    echo "‚ùå Knowledge base directory not found: $kb_dir"
    return 1
  fi
  
  # –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç deploy_knowledgebase.sh –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
  if [ -f "$kb_dir/deploy_knowledgebase.sh" ]; then
    chmod +x "$kb_dir/deploy_knowledgebase.sh"
    echo "‚úÖ Knowledge base deployment script prepared"
  else
    echo "‚ö†Ô∏è Knowledge base deployment script not found: $kb_dir/deploy_knowledgebase.sh"
  fi
}

deploy_knowledgebase() {
  echo -e "\nüöÄ Deploying knowledge base services‚Ä¶"
  local kb_dir="unicchat.enterprise/knowledgebase"
  
  if [ ! -f "$kb_dir/deploy_knowledgebase.sh" ]; then
    echo "‚ùå Knowledge base deployment script not found"
    return 1
  fi
  
  # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
  echo "üì¶ Running knowledge base deployment..."
  (cd "$kb_dir" && ./deploy_knowledgebase.sh --auto)
  
  echo "‚úÖ Knowledge base services deployed"
}

prepare_vcs() {
  echo -e "\nüìπ Preparing VCS (Video Communication Server)‚Ä¶"
  
  local vcs_dir="unicchat.enterprise/vcs.unic.chat.template"
  
  if [ ! -d "$vcs_dir" ]; then
    echo "‚ùå VCS directory not found: $vcs_dir"
    return 1
  fi
  
  # –ó–∞–≥—Ä—É–∂–∞–µ–º VCS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
  if [ ! -f "$VCS_CONFIG" ]; then
    echo "‚ùå VCS configuration not found. Run step 5 first."
    return 1
  fi
  source "$VCS_CONFIG"
  
  # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –¥–ª—è VCS
  cat > "$vcs_dir/.env" <<EOF
# –¥–æ–º–µ–Ω—ã VCS –¥–ª—è —Ä–∞–±–æ—Ç—ã, –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ –¥–æ—Å—Ç—É–ø–Ω—ã
# –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞–¥–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —á–µ—Ä–µ–∑ caddy

VCS_URL=$VCS_DNS
VCS_TURN_URL=$VCS_TURN_DNS
VCS_WHIP_URL=$VCS_WHIP_DNS
EOF
  
  echo "‚úÖ VCS .env file created with DNS names"
  
  # –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏
  chmod +x "$vcs_dir/install_server.sh" 2>/dev/null || true
  chmod +x "$vcs_dir/install_docker.sh" 2>/dev/null || true
  chmod +x "$vcs_dir/update_ip.sh" 2>/dev/null || true
  
  echo "‚úÖ VCS preparation complete"
}

install_vcs() {
  echo -e "\nüöÄ Installing VCS (Video Communication Server)‚Ä¶"
  
  local vcs_dir="unicchat.enterprise/vcs.unic.chat.template"
  local vcs_compose_dir="$vcs_dir/unicomm-vcs"
  local vcs_compose_file="$vcs_compose_dir/docker-compose.yaml"
  
  if [ ! -f "$vcs_dir/install_server.sh" ]; then
    echo "‚ùå VCS installation script not found"
    return 1
  fi
  
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env —Ñ–∞–π–ª–∞
  if [ ! -f "$vcs_dir/.env" ]; then
    echo "‚ùå VCS .env file not found. Run step 5 and VCS preparation first."
    return 1
  fi
  
  # –û—á–∏—â–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è–º–∏
  if [ -d "$vcs_compose_dir/caddy.yaml" ]; then
    echo "üîÑ Removing conflicting directory: $vcs_compose_dir/caddy.yaml"
    rm -rf "$vcs_compose_dir/caddy.yaml"
  fi
  
  echo "üì¶ Running VCS installation..."
  (cd "$vcs_dir" && ./install_server.sh)
  
  if [ $? -ne 0 ]; then
    echo "‚ùå VCS installation failed. Trying alternative approach..."
    
    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥: —Å–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª—ã –≤—Ä—É—á–Ω—É—é
    echo "üîÑ Creating VCS files manually..."
    
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    mkdir -p "$vcs_compose_dir/caddy_data"
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º VCS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è DNS –∏–º–µ–Ω
    source "$VCS_CONFIG"
    
    # –°–æ–∑–¥–∞–µ–º vcs.yaml
    cat > "$vcs_compose_dir/vcs.yaml" <<EOF
port: 7880
bind_addresses:
    - ""
rtc:
    tcp_port: 7881
    port_range_start: 50000
    port_range_end: 60000
    use_external_ip: true
    enable_loopback_candidate: false
redis:
    address: localhost:6379
    username: ""
    password: ""
    db: 0
    use_tls: false
    sentinel_master_name: ""
    sentinel_username: ""
    sentinel_password: ""
    sentinel_addresses: []
    cluster_addresses: []
    max_redirects: null
turn:
    enabled: true
    domain: $VCS_TURN_DNS
    tls_port: 5349
    udp_port: 3478
    external_tls: true
keys:
    APIFB6qLxKJDW7T: 1jH9vBVaFfBwMXDaBcjkQG8d6z5GBhUowsz2VhiDoqe
EOF
    
    # –ü–æ–ª—É—á–∞–µ–º IP —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è caddy.yaml
    SERVER_IP=$(curl -s ifconfig.me || curl -s icanhazip.com || hostname -I | awk '{print $1}')
    
    # –°–æ–∑–¥–∞–µ–º caddy.yaml
    cat > "$vcs_compose_dir/caddy.yaml" <<EOF
logging:
  logs:
    default:
      level: INFO
storage:
  "module": "file_system"
  "root": "/data"
apps:
  tls:
    certificates:
      automate:
        - $VCS_URL
        - $VCS_TURN_URL
  layer4:
    servers:
      main:
        listen: [":443"]
        routes:
          - match:
            - tls:
                sni:
                  - "$VCS_TURN_URL"
            handle:
              - handler: tls
              - handler: proxy
                upstreams:
                  - dial: ["localhost:5349"]
          - match:
              - tls:
                  sni:
                    - "$VCS_URL"
            handle:
              - handler: tls
                connection_policies:
                  - alpn: ["http/1.1"]
              - handler: proxy
                upstreams:
                  - dial: ["localhost:7880"]
EOF
    
    # –°–æ–∑–¥–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
    cat > "$vcs_compose_dir/redis.conf" <<EOF
bind 127.0.0.1 ::1
protected-mode yes
port 6379
timeout 0
tcp-keepalive 300
EOF
    
    cat > "$vcs_compose_dir/egress.yaml" <<EOF
redis:
    address: localhost:6379
    username: ""
    password: ""
    db: 0
    use_tls: false
    sentinel_master_name: ""
    sentinel_username: ""
    sentinel_password: ""
    sentinel_addresses: []
    cluster_addresses: []
    max_redirects: null
api_key: APIFB6qLxKJDW7T
api_secret: 1jH9vBVaFfBwMXDaBcjkQG8d6z5GBhUowsz2VhiDoqe
ws_url: wss://$VCS_URL
EOF
    
    # –°–æ–∑–¥–∞–µ–º update_ip.sh
    cat > "$vcs_compose_dir/update_ip.sh" <<"EOF"
#!/usr/bin/env bash
ip=`ip addr show |grep "inet " |grep -v 127.0.0. |head -1|cut -d" " -f6|cut -d/ -f1`
sed -i.orig -r "s/\\\"(.+)(\:5349)/\\\"$ip\2/" ./unicomm-vcs/caddy.yaml
EOF
    
    chmod +x "$vcs_compose_dir/update_ip.sh"
  fi
  
  # –ü–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–π IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞
  echo "üåê Getting server external IP address..."
  SERVER_IP=$(curl -s ifconfig.me || curl -s icanhazip.com || hostname -I | awk '{print $1}')
  
  if [ -z "$SERVER_IP" ]; then
    echo "‚ö†Ô∏è Could not determine external IP, using local IP"
    SERVER_IP=$(hostname -I | awk '{print $1}')
  fi
  
  echo "üìù Setting external IP: $SERVER_IP"
  
  # –°–æ–∑–¥–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π docker-compose —Ñ–∞–π–ª
  if [ -f "$vcs_compose_file" ]; then
    # –°–æ–∑–¥–∞–µ–º backup
    cp "$vcs_compose_file" "$vcs_compose_file.backup"
    
    # –°–æ–∑–¥–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
    cat > "$vcs_compose_file" <<EOF
# This docker-compose requires host networking, which is only available on Linux
# This compose will not function correctly on Mac or Windows
services:
  caddy:
    image: livekit/caddyl4:latest
    command: run --config /etc/caddy.yaml --adapter yaml
    restart: unless-stopped
    network_mode: "host"
    volumes:
      - ./caddy.yaml:/etc/caddy.yaml
      - ./caddy_data:/data
  vcs:
    image: livekit/livekit-server:v1.7.2
    command: --config /etc/livekit.yaml
    restart: unless-stopped
    network_mode: "host"
    volumes:
      - ./vcs.yaml:/etc/livekit.yaml
    environment:
      - LIVEKIT_IP=$SERVER_IP
  redis:
    image: redis:7.4.1-alpine
    command: redis-server /etc/redis.conf
    restart: unless-stopped
    network_mode: "host"
    volumes:
      - ./redis.conf:/etc/redis.conf
  egress:
    image: livekit/egress:latest
    restart: unless-stopped
    environment:
      - EGRESS_CONFIG_FILE=/etc/egress.yaml
    network_mode: "host"
    volumes:
      - ./egress.yaml:/etc/egress.yaml
    cap_add:
      - CAP_SYS_ADMIN
EOF
    
    echo "‚úÖ Created corrected docker-compose.yaml with LIVEKIT_IP=$SERVER_IP"
    
  else
    echo "‚ùå VCS docker-compose.yaml not found"
    return 1
  fi
  
  # –ó–∞–ø—É—Å–∫–∞–µ–º docker-compose –¥–ª—è VCS
  echo "üê≥ Starting VCS services with docker-compose..."
  (cd "$vcs_compose_dir" && docker-compose up -d)
  
  if [ $? -eq 0 ]; then
    echo "‚úÖ VCS docker-compose started successfully with external IP: $SERVER_IP"
  else
    echo "‚ùå Failed to start VCS docker-compose"
    echo "üîç Checking docker-compose file syntax..."
    docker-compose -f "$vcs_compose_file" config
    return 1
  fi
  
  echo "‚úÖ VCS installation completed"
}

auto_setup() {
  echo -e "\n‚öôÔ∏è Running full automatic setup‚Ä¶"
  install_docker
  install_nginx_ssl
  install_git
  install_dns_utils
  install_minio_client
  clone_repo
  check_avx
  setup_dns_names
  setup_license
  update_mongo_config
  update_minio_config
  generate_nginx_conf
  deploy_nginx_conf
  copy_ssl_configs
  setup_ssl
  activate_nginx
  prepare_unicchat
  login_yandex
  start_unicchat
  update_site_url
  prepare_knowledgebase
  deploy_knowledgebase
  update_env_files
  prepare_vcs
  install_vcs
  echo -e "\nüéâ UnicChat setup complete! (including knowledge base and VCS)"
}

main_menu() {
  echo -e "\n‚ú® Welcome to UnicChat Installer with VCS"
  echo -e "‚úÖ Email: $EMAIL"
  
  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
  if [ -f "$DNS_CONFIG" ] && [ -f "$VCS_CONFIG" ]; then
    source "$DNS_CONFIG"
    source "$VCS_CONFIG"
    echo "üìã Current DNS configuration:"
    echo "   App Server: $APP_DNS"
    echo "   Document Server: $EDT_DNS"
    echo "   MinIO: $MINIO_DNS"
    echo "   VCS: $VCS_DNS"
    echo "   VCS TURN: $VCS_TURN_DNS"
    echo "   VCS WHIP: $VCS_WHIP_DNS"
  fi
  
  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏—Ü–µ–Ω–∑–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
  if [ -n "$UNIC_LICENSE" ]; then
    echo "üîë License: $UNIC_LICENSE"
  else
    echo "‚ö†Ô∏è No license configured"
  fi
  echo ""
  
  while true; do
    cat <<MENU
 [1]  Install Docker
 [2]  Install Nginx and Certbot
 [3]  Install Git
 [4]  Install DNS utilities
 [5]  Install MinIO client (mc)
 [6]  Clone repository
 [7]  Check AVX support
 [8]  Setup DNS names for all services (including VCS)
 [9]  Setup License Key
[10]  Update MongoDB configuration
[11]  Update MinIO configuration
[12]  Generate Nginx configs
[13]  Deploy Nginx configs
[14]  Copy SSL configs and generate DH params
[15]  Setup SSL certificates (all domains)
[16]  Activate Nginx sites
[17]  Prepare .env files
[18]  Login to Yandex registry
[19]  Start UnicChat containers
[20]  Update MongoDB Site_Url
[21]  Prepare knowledge base
[22]  Deploy knowledge base services
[23]  üîó Link Knowledgebase with UnicChat
[24]  üìπ Prepare VCS
[25]  üìπ Install VCS
[99]  üöÄ Full automatic setup (with knowledge base and VCS)
 [0]  Exit
MENU
    read -rp "üëâ Select an option: " choice
    case $choice in
      1) install_docker ;;
      2) install_nginx_ssl ;;
      3) install_git ;;
      4) install_dns_utils ;;
      5) install_minio_client ;;
      6) clone_repo ;;
      7) check_avx ;;
      8) setup_dns_names ;;
      9) setup_license ;;
     10) update_mongo_config ;;
     11) update_minio_config ;;
     12) generate_nginx_conf ;;
     13) deploy_nginx_conf ;;
     14) copy_ssl_configs ;;
     15) setup_ssl ;;
     16) activate_nginx ;;
     17) prepare_unicchat ;;
     18) login_yandex ;;
     19) start_unicchat ;;
     20) update_site_url ;;
     21) prepare_knowledgebase ;;
     22) deploy_knowledgebase ;;
     23) update_env_files ;;
     24) prepare_vcs ;;
     25) install_vcs ;;
     99) auto_setup ;;
      0) echo "üëã Goodbye!" && break ;;
      *) echo "‚ùì Invalid option." ;;
    esac
    echo ""
  done
}

# === Start ===
load_config
main_menu "$@"
